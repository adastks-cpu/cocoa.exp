<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Red-Diamond Pricing Study</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --page-bg: #e0daf7;     /* page background */
      --card: #f7f5da;        /* cards / text surfaces */
      --primary: #fac8fa;     /* button active bg */
      --icon-title: #92d1cf;  /* icons + h1/h2/h3 */
      --text: #261d69;        /* normal text */
      --muted: #5a4a9e;       /* secondary text */
      --border: #c8b8f0;
      --error: #e74c3c;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--page-bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    
    .card {
      width: 100%;
      max-width: 700px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      box-sizing: border-box;
    }
    
    h1, h2, h3 { 
      margin-top: 0; 
      color: var(--icon-title); 
    }

    .icon-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: flex-start;
    }
    
    .icon-row svg {
      width: 20px;
      height: 20px;
      color: var(--icon-title);
      flex-shrink: 0;
      margin-top: 3px;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    button {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s ease;
      position: relative;
      z-index: 1;
    }
    
    button:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    button.active {
      background: var(--primary);
      color: var(--text);
      border-color: var(--primary);
      font-weight: 600;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
      color: var(--text);
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      font-size: 0.9rem;
    }
    
    th, td {
      padding: 0.5rem 0.6rem;
      border: 1px solid var(--border);
      text-align: center;
    }
    
    th { 
      background: var(--card); 
    }
    
    .hidden { 
      display: none; 
    }

    /* ---- full-screen Coco ---- */
    #coco {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 999;
      opacity: 0;
      transform: scale(1.05);
      transition: opacity .6s ease, transform .6s ease;
    }
    
    #coco.show {
      opacity: 1;
      transform: scale(1);
    }
    
    #coco.wag {
      animation: wag .5s ease-in-out 6;
    }
    
    @keyframes wag {
      0%, 100% { transform: scale(1) rotate(-4deg); }
      50% { transform: scale(1) rotate(4deg); }
    }
    
    #coco-bubble {
      position: fixed;
      top: 5vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff9;
      color: var(--text);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 1.4rem;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transform: translateX(-50%) scale(.8);
      transition: opacity .4s, transform .4s;
    }
    
    #coco-bubble.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    .label {
      display: block;
      margin: 1rem 0 0.5rem 0;
      font-weight: 500;
    }

    /* Debug styles */
    .debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 10000;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <!-- Debug Info Panel -->
  <div id="debug-panel" class="debug-info" style="display: none;">
    <div><strong>Debug Info:</strong></div>
    <div id="debug-content"></div>
    <button onclick="document.getElementById('debug-panel').style.display='none'">Close</button>
  </div>

  <!-- CONSENT CARD -->
  <div id="consent-card" class="card">
    <h1>Research Consent Form</h1>
    <p style="color: var(--muted)">Please read the following information carefully before proceeding.</p>

    <div class="icon-row">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
        <path d="M12 8v8m-4-4h8"/>
      </svg>
      <div>
        <h3>What is the purpose of our study?</h3>
        <p>We study how individuals estimate the value of an object under uncertainty, specifically a one-carat natural red diamond (USD).</p>
      </div>
    </div>

    <div class="icon-row">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </svg>
      <div>
        <h3>What does participation entail?</h3>
        <p>About 5 minutes: one question and a short debrief. Participation is voluntary; you may stop at any time.</p>
      </div>
    </div>

    <div class="icon-row">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0110 0v4"/>
      </svg>
      <div>
        <h3>Confidentiality</h3>
        <p>No personal identifiers are collected. All data are anonymous and analysed only in aggregate.</p>
      </div>
    </div>

    <div class="icon-row">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
      <div>
        <h3>Contact</h3>
        <p>Questions: <a href="mailto:a.simsek@student.uw.edu.pl">a.simsek@student.uw.edu.pl</a> or <a href="mailto:z.zboch@student.uw.edu.pl">z.zboch@student.uw.edu.pl</a></p>
      </div>
    </div>

    <p style="margin-top: 1.5rem"><strong>By clicking "YES" you confirm that you have read and understood the information above and freely consent to participate.</strong></p>

    <div class="btn-group">
      <button type="button" id="consent-yes">YES, I give consent</button>
      <button type="button" id="consent-no">NO, I don't give consent</button>
    </div>
  </div>

  <!-- QUESTION CARD -->
  <div id="question-card" class="card hidden">
    <h2>Diamond price estimation</h2>
    <p>What is the starting price of a one-carat natural red diamond?</p>
    <p style="font-weight: 600; color: var(--primary)" id="anchor-line"></p>

    <div class="btn-group">
      <button type="button" id="underBtn">Under</button>
      <button type="button" id="overBtn">Over</button>
    </div>

    <label for="estimate" class="label">Give your estimation of the real starting price (USD):</label>
    <input id="estimate" type="text" inputmode="numeric" placeholder="Digits only" disabled>

    <div class="btn-group">
      <button type="button" id="submitBtn" disabled>Submit</button>
    </div>
  </div>

  <!-- THANK-YOU / DECLINE CARD -->
  <div id="decline-card" class="card hidden">
    <p>Thank you for your time. You have chosen not to participate in this study.</p>
    <p style="color: var(--muted)">You may close this page.</p>
  </div>

  <!-- LIVE DATA TABLE -->
  <div id="data-card" class="card hidden">
    <h2>Collected answers (live)</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Anchor</th>
          <th>Choice</th>
          <th>Estimate (USD)</th>
        </tr>
      </thead>
      <tbody id="data-body"></tbody>
    </table>
    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--muted)">
      Tip: select & copy the table when you want to save the data.
    </p>
  </div>

  <!-- full-screen Coco -->
  <img id="coco" src="https://i.imgur.com/yqxC5K4.jpeg" alt="Coco says thanks!">
  <div id="coco-bubble">Thanks for helping science!<br>Love, Coco üêæ</div>

  <script>
    // Debug function
    function debug(message) {
      console.log('[DIAMOND STUDY DEBUG]:', message);
      const debugPanel = document.getElementById('debug-panel');
      const debugContent = document.getElementById('debug-content');
      if (debugPanel && debugContent) {
        debugContent.innerHTML += message + '<br>';
        debugPanel.style.display = 'block';
      }
    }

    // Global variables
    let anchor = 0;
    let choice = '';
    let rows = [];

    // Debug: Show when script loads
    debug('Script loaded successfully');

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      debug('DOM fully loaded');
      
      // Initialize event listeners
      initializeEventListeners();
    });

    function initializeEventListeners() {
      debug('Initializing event listeners...');
      
      // Consent buttons
      const consentYes = document.getElementById('consent-yes');
      const consentNo = document.getElementById('consent-no');
      
      if (consentYes) {
        consentYes.addEventListener('click', function() {
          debug('Consent YES clicked');
          start(true);
        });
      } else {
        debug('ERROR: consent-yes button not found');
      }
      
      if (consentNo) {
        consentNo.addEventListener('click', function() {
          debug('Consent NO clicked');
          start(false);
        });
      } else {
        debug('ERROR: consent-no button not found');
      }
      
      // Choice buttons
      const underBtn = document.getElementById('underBtn');
      const overBtn = document.getElementById('overBtn');
      
      if (underBtn) {
        underBtn.addEventListener('click', function() {
          debug('Under button clicked');
          pick('under');
        });
      } else {
        debug('ERROR: underBtn not found');
      }
      
      if (overBtn) {
        overBtn.addEventListener('click', function() {
          debug('Over button clicked');
          pick('over');
        });
      } else {
        debug('ERROR: overBtn not found');
      }
      
      // Submit button
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.addEventListener('click', function() {
          debug('Submit button clicked');
          submit();
        });
      } else {
        debug('ERROR: submitBtn not found');
      }
      
      // Estimate input
      const estimate = document.getElementById('estimate');
      if (estimate) {
        estimate.addEventListener('input', function(e) {
          debug('Estimate input changed: ' + e.target.value);
          // Remove non-digits
          const originalValue = e.target.value;
          e.target.value = e.target.value.replace(/\D/g, '');
          if (originalValue !== e.target.value) {
            debug('Removed non-digits from input');
          }
          
          // Enable/disable submit button
          const submitBtn = document.getElementById('submitBtn');
          if (submitBtn) {
            const shouldEnable = choice && e.target.value;
            submitBtn.disabled = !shouldEnable;
            debug('Submit button disabled: ' + !shouldEnable);
          }
        });
      } else {
        debug('ERROR: estimate input not found');
      }
      
      debug('Event listeners initialized');
    }

    // Storage functions with error handling
    function safeSessionStorageGet(key) {
      try {
        return sessionStorage.getItem(key);
      } catch (e) {
        debug('sessionStorage get error: ' + e.message);
        return null;
      }
    }

    function safeSessionStorageSet(key, value) {
      try {
        sessionStorage.setItem(key, value);
        return true;
      } catch (e) {
        debug('sessionStorage set error: ' + e.message);
        return false;
      }
    }

    // Counter functions
    const COUNTER_KEY = 'cocoCounter';
    
    function getNextAnchor() {
      try {
        let c = JSON.parse(safeSessionStorageGet(COUNTER_KEY) || '{"total":0,"A":0,"B":0}');
        c.total++;
        
        if (c.A <= c.B) { 
          anchor = 10000;  
          c.A++; 
        } else {            
          anchor = 1000000; 
          c.B++; 
        }
        
        safeSessionStorageSet(COUNTER_KEY, JSON.stringify(c));
        debug('Anchor selected: ' + anchor + ' (A: ' + c.A + ', B: ' + c.B + ')');
        return anchor;
      } catch (e) {
        debug('Error in getNextAnchor: ' + e.message);
        anchor = 10000; // fallback
        return anchor;
      }
    }

    // Consent function
    function start(consent) {
      debug('start() called with consent: ' + consent);
      
      if (!consent) {
        show('decline-card');
        return;
      }
      
      try {
        anchor = getNextAnchor();
        const anchorLine = document.getElementById('anchor-line');
        if (anchorLine) {
          anchorLine.textContent = anchor.toLocaleString() + ' USD ‚Äì more or less?';
          debug('Anchor line updated: ' + anchorLine.textContent);
        } else {
          debug('ERROR: anchor-line element not found');
        }
        
        show('question-card');
      } catch (e) {
        debug('Error in start(): ' + e.message);
      }
    }

    // Choice function
    function pick(val) {
      debug('pick() called with value: ' + val);
      
      choice = val;
      
      const underBtn = document.getElementById('underBtn');
      const overBtn = document.getElementById('overBtn');
      
      if (underBtn && overBtn) {
        underBtn.classList.toggle('active', val === 'under');
        overBtn.classList.toggle('active', val === 'over');
        debug('Choice buttons updated');
      }
      
      const estimate = document.getElementById('estimate');
      if (estimate) {
        estimate.disabled = false;
        debug('Estimate input enabled');
      }
      
      // Check if we should enable submit button
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn && choice && estimate.value) {
        submitBtn.disabled = false;
        debug('Submit button enabled');
      }
    }

    // Submit function
    function submit() {
      debug('submit() function called');
      
      const estimate = document.getElementById('estimate');
      if (!estimate) {
        debug('ERROR: estimate input not found');
        return;
      }
      
      const est = parseInt(estimate.value, 10);
      debug('Parsed estimate: ' + est);
      
      if (!choice || !est) {
        debug('Validation failed - choice: ' + choice + ', estimate: ' + est);
        return;
      }

      // Store data locally
      rows.push({
        anchor: anchor,
        choice: choice,
        estimate: est
      });
      
      debug('Data stored locally, rows: ' + rows.length);

      // Use traditional form submission instead of fetch to avoid CORS
      try {
        const formURL = 'https://docs.google.com/forms/d/e/1s3gJw-ONH603ixG4xQmLdkThpNzwOfGo4KCVIkfM4Vo/formResponse';
        
        // Create a hidden form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = formURL;
        form.target = '_blank'; // Open in new tab to avoid navigation issues
        
        // Add form fields
        const fields = {
          'entry.430162608': new Date().toISOString(),
          'entry.493712886': anchor,
          'entry.583518581': choice,
          'entry.1271062354': est
        };
        
        for (const [key, value] of Object.entries(fields)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        debug('Form submitted successfully');
        
        // Show success message
        alert('Thank you! Your answer has been recorded.');
        
        // Show Coco animation
        showCocoAnimation();
        
        // Show data table
        renderTable();
        
        // Reset form
        resetForm();
        
      } catch (e) {
        debug('Error in form submission: ' + e.message);
        alert('Network error ‚Äì please try again.');
      }
    }

    function showCocoAnimation() {
      debug('Showing Coco animation');
      
      const coco = document.getElementById('coco');
      const bubble = document.getElementById('coco-bubble');
      
      if (coco && bubble) {
        coco.classList.add('show', 'wag');
        bubble.classList.add('show');
        
        setTimeout(() => {
          coco.classList.remove('show', 'wag');
          bubble.classList.remove('show');
          debug('Coco animation ended');
        }, 4000);
      }
    }

    function resetForm() {
      debug('Resetting form');
      
      choice = '';
      
      const underBtn = document.getElementById('underBtn');
      const overBtn = document.getElementById('overBtn');
      const estimate = document.getElementById('estimate');
      const submitBtn = document.getElementById('submitBtn');
      
      if (underBtn) underBtn.classList.remove('active');
      if (overBtn) overBtn.classList.remove('active');
      if (estimate) {
        estimate.value = '';
        estimate.disabled = true;
      }
      if (submitBtn) submitBtn.disabled = true;
      
      debug('Form reset complete');
    }

    function renderTable() {
      debug('Rendering table with ' + rows.length + ' rows');
      
      const tbody = document.getElementById('data-body');
      if (!tbody) {
        debug('ERROR: data-body not found');
        return;
      }
      
      tbody.innerHTML = '';
      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.anchor.toLocaleString()}</td>
          <td>${r.choice}</td>
          <td>${r.estimate.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
      
      show('data-card');
      debug('Table rendered');
    }

    function show(cardId) {
      debug('Showing card: ' + cardId);
      
      const cards = ['consent-card','question-card','decline-card','data-card'];
      cards.forEach(c => {
        const card = document.getElementById(c);
        if (card) {
          card.classList.add('hidden');
        }
      });
      
      const targetCard = document.getElementById(cardId);
      if (targetCard) {
        targetCard.classList.remove('hidden');
        debug('Card ' + cardId + ' is now visible');
      } else {
        debug('ERROR: Target card ' + cardId + ' not found');
      }
    }

    // Debug: Enable debug mode by adding ?debug=true to URL
    if (window.location.search.includes('debug=true')) {
      document.getElementById('debug-panel').style.display = 'block';
      debug('Debug mode enabled');
    }
  </script>
</body>
</html>
